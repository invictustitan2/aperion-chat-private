name = "aperion-api-worker"
main = "src/index.ts"
compatibility_date = "2024-09-23"
compatibility_flags = ["nodejs_compat"]

routes = [
        { pattern = "api.aperion.cc", custom_domain = true, zone_name = "aperion.cc" },
        # Path B: same-origin API mount served by this Worker
        { pattern = "chat.aperion.cc/api/*", zone_name = "aperion.cc" }
]

[[d1_databases]]
binding = "MEMORY_DB"
database_name = "aperion-memory"
database_id = "48f0940c-841b-452c-a54a-cb9f8c625df2"

[[kv_namespaces]]
binding = "CACHE_KV"
id = "212d43171f574b06b22f6fa4f24ca8a1"

[vars]
# API_TOKEN will be set via secrets
#
# Config drift contract (validated by scripts/guard-config-drift.*):
#
# required_vars:
# - APERION_AUTH_MODE
# - CF_ACCESS_TEAM_DOMAIN
# - CF_ACCESS_AUD
#
# optional_vars:
# - APERION_AUTH_LOG_OUTCOMES
# - CF_ACCESS_JWKS_TTL_MS
# - CF_ACCESS_JWT_CLOCK_SKEW_SECONDS
# - CF_ACCESS_SERVICE_TOKEN_ID
# - CF_ACCESS_SERVICE_TOKEN_SECRET
# - GOOGLE_APPLICATION_CREDENTIALS_JSON
# - GEMINI_API_KEY
# - GEMINI_MODEL
# - APERION_ENV
# - ENVIRONMENT
# - NODE_ENV

[[vectorize]]
binding = "MEMORY_VECTORS"
index_name = "aperion-vectors"

[ai]
binding = "AI"

[[durable_objects.bindings]]
name = "CHAT_STATE"
class_name = "ChatState"

[[migrations]]
tag = "v1" # Should be unique for each migration
new_classes = ["ChatState"]

[[queues.producers]]
binding = "MEMORY_QUEUE"
queue = "aperion-memory-queue"

[[queues.consumers]]
queue = "aperion-memory-queue"
max_batch_size = 10
max_batch_timeout = 5

[[r2_buckets]]
binding = "MEDIA_BUCKET"
bucket_name = "aperion-media"

[triggers]
crons = ["0 0 * * *"]

[browser]
binding = "BROWSER"

[observability]
enabled = true

[observability.logs]
enabled = true
head_sampling_rate = 1
invocation_logs = true
persist = true

[[analytics_engine_datasets]]
binding = "METRICS"
dataset = "aperion_metrics"

# Test environment configuration
# Minimal bindings for faster startup in tests
[env.test]
[env.test.vars]
API_TOKEN = "test-token"
APERION_ENV = "test"

[env.test.ai]
binding = "AI"

[env.test.browser]
binding = "BROWSER"

# Only include essential bindings for auth tests
# D1 database for basic functionality
[[env.test.d1_databases]]
binding = "MEMORY_DB"
database_name = "aperion-memory-test"
database_id = "test-db-local"

# NOTE: Wrangler environments do not inherit bindings from the top-level config.
# We define these explicitly to avoid "not inherited" warnings and future test
# surprises if/when tests start depending on these bindings.

[[env.test.kv_namespaces]]
binding = "CACHE_KV"
id = "212d43171f574b06b22f6fa4f24ca8a1"

[[env.test.vectorize]]
binding = "MEMORY_VECTORS"
index_name = "aperion-vectors"

[[env.test.durable_objects.bindings]]
name = "CHAT_STATE"
class_name = "ChatState"

[[env.test.migrations]]
tag = "v1"
new_classes = ["ChatState"]

[[env.test.queues.producers]]
binding = "MEMORY_QUEUE"
queue = "aperion-memory-queue"

[[env.test.queues.consumers]]
queue = "aperion-memory-queue"
max_batch_size = 10
max_batch_timeout = 5

[[env.test.r2_buckets]]
binding = "MEDIA_BUCKET"
bucket_name = "aperion-media"

[[env.test.analytics_engine_datasets]]
binding = "METRICS"
dataset = "aperion_metrics"

# Preview environment (used by GitHub PR preview workflow)
# - Separate Worker name
# - workers.dev enabled
# - No production custom-domain routes
[env.preview]
name = "aperion-api-worker-preview"
workers_dev = true
routes = []

[env.preview.vars]
# API_TOKEN will be set via secrets
#
# required_vars:
# - APERION_AUTH_MODE
# - CF_ACCESS_TEAM_DOMAIN
# - CF_ACCESS_AUD

[[env.preview.d1_databases]]
binding = "MEMORY_DB"
database_name = "aperion-memory"
database_id = "48f0940c-841b-452c-a54a-cb9f8c625df2"

[[env.preview.kv_namespaces]]
binding = "CACHE_KV"
id = "212d43171f574b06b22f6fa4f24ca8a1"

[[env.preview.durable_objects.bindings]]
name = "CHAT_STATE"
class_name = "ChatState"

[[env.preview.migrations]]
tag = "v1"
new_classes = ["ChatState"]

# Optional bindings are undefined in tests - code handles gracefully
# AI, VECTORIZE, R2, BROWSER, QUEUES are not needed for auth tests
# Trigger deployment for permission check
