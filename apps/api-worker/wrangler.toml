name = "aperion-api-worker"
main = "src/index.ts"
compatibility_date = "2024-03-20"
compatibility_flags = ["nodejs_compat"]

routes = [
        { pattern = "api.aperion.cc", custom_domain = true, zone_name = "aperion.cc" }
]

[[d1_databases]]
binding = "MEMORY_DB"
database_name = "aperion-memory"
database_id = "48f0940c-841b-452c-a54a-cb9f8c625df2"

[[kv_namespaces]]
binding = "CACHE_KV"
id = "212d43171f574b06b22f6fa4f24ca8a1"

[vars]
# API_TOKEN will be set via secrets

[[vectorize]]
binding = "MEMORY_VECTORS"
index_name = "aperion-vectors"

[ai]
binding = "AI"

[[durable_objects.bindings]]
name = "CHAT_STATE"
class_name = "ChatState"

[[migrations]]
tag = "v1" # Should be unique for each migration
new_classes = ["ChatState"]

[[queues.producers]]
binding = "MEMORY_QUEUE"
queue = "aperion-memory-queue"

[[queues.consumers]]
queue = "aperion-memory-queue"
max_batch_size = 10
max_batch_timeout = 5

[[r2_buckets]]
binding = "MEDIA_BUCKET"
bucket_name = "aperion-media"

[triggers]
crons = ["0 0 * * *"]

[browser]
binding = "BROWSER"

[observability]
enabled = true

[observability.logs]
enabled = true
head_sampling_rate = 1
invocation_logs = true
persist = true

[[analytics_engine_datasets]]
binding = "METRICS"
dataset = "aperion_metrics"

# Test environment configuration
# Minimal bindings for faster startup in tests
[env.test]
# Only include essential bindings for auth tests
# D1 database for basic functionality
[[env.test.d1_databases]]
binding = "MEMORY_DB"
database_name = "aperion-memory-test"
database_id = "test-db-local"

# Optional bindings are undefined in tests - code handles gracefully
# AI, VECTORIZE, R2, BROWSER, QUEUES are not needed for auth tests
# Trigger deployment for permission check
