
 RUN  v3.2.4 /home/dreamboat/projects/aperion-chat-private


 ⛅️ wrangler 4.55.0
───────────────────
Resource location: local 

Use --remote if you want to access the remote instance.

✅ No migrations to apply!
 ✓ apps/api-worker/test/index.test.ts (7 tests) 5300ms
   ✓ API Worker Integration > Missing Authorization -> 401 with exact error shape  2658ms

 ⛅️ wrangler 4.55.0
───────────────────
Resource location: local 

Use --remote if you want to access the remote instance.

✅ No migrations to apply!
stdout | apps/api-worker/test/auth.test.ts > Authentication Middleware
Starting worker...

stdout | apps/api-worker/test/auth.test.ts > Authentication Middleware
Waiting for worker to be ready...
Will poll every 500ms for up to 12 attempts (6s total)

stdout | apps/api-worker/test/auth.test.ts > Authentication Middleware
Attempt 1: Got response with status 401
✓ Worker ready after 1 attempts (~0.5s)

 ✓ apps/api-worker/test/auth.test.ts (23 tests) 5708ms
   ✓ Authentication Middleware > Protected Endpoints > should allow authenticated GET /v1/semantic/search?query=test  429ms
 ✓ apps/api-worker/test/lib/authContext.test.ts (4 tests) 495ms
   ✓ getAuthContext (Cloudflare Access) > refreshes JWKS once when kid is unknown  337ms
 ✓ test/verify-ci.test.ts (3 tests) 781ms
   ✓ verify:ci > local mode does not hard-fail when Cloudflare account id is missing  474ms
 ✓ test/cf-doctor.test.ts (1 test) 187ms
 ✓ tools/cli/test/cli.test.ts (4 tests) 97ms
stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > Missing Authorization -> 401 (auth middleware wired)
{"level":"info","message":"Incoming request: GET http://local.test/v1/conversations","traceId":"9c5107af-384d-4e99-92f7-dcf9fc74a362","source":"api-worker","timestamp":"2025-12-30T04:14:44.814Z","method":"GET","url":"http://local.test/v1/conversations","userAgent":null}

stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > Missing Authorization -> 401 (auth middleware wired)
{"level":"warn","message":"Auth outcome","traceId":"9c5107af-384d-4e99-92f7-dcf9fc74a362","source":"api-worker","timestamp":"2025-12-30T04:14:44.815Z","event":"auth.outcome","outcome":"deny","mode":"token","method":"GET","path":"/v1/conversations","status":401,"reason":"Unauthorized (missing bearer token)","durationMs":0}

stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > Missing Authorization -> 401 (auth middleware wired)
{"level":"info","message":"Request completed","traceId":"9c5107af-384d-4e99-92f7-dcf9fc74a362","source":"api-worker","timestamp":"2025-12-30T04:14:44.816Z","status":401,"durationMs":2.2232489999987592}

stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > Access mode missing assertion -> 401 (fail-closed canary)
{"level":"info","message":"Incoming request: GET http://local.test/v1/conversations","traceId":"10b73352-b1c2-422f-87cf-f20a3fb2ad3b","source":"api-worker","timestamp":"2025-12-30T04:14:44.818Z","method":"GET","url":"http://local.test/v1/conversations","userAgent":null}

stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > Access mode missing assertion -> 401 (fail-closed canary)
{"level":"warn","message":"Auth outcome","traceId":"10b73352-b1c2-422f-87cf-f20a3fb2ad3b","source":"api-worker","timestamp":"2025-12-30T04:14:44.819Z","event":"auth.outcome","outcome":"deny","mode":"access","method":"GET","path":"/v1/conversations","status":401,"reason":"Missing Access assertion (expected CF-Access-Jwt-Assertion header or CF_Authorization cookie)","durationMs":0}

stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > Access mode missing assertion -> 401 (fail-closed canary)
{"level":"info","message":"Request completed","traceId":"10b73352-b1c2-422f-87cf-f20a3fb2ad3b","source":"api-worker","timestamp":"2025-12-30T04:14:44.820Z","status":401,"durationMs":2.0479709999999614}

stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > OPTIONS -> 204 and includes CORS headers
{"level":"info","message":"Incoming request: OPTIONS http://local.test/v1/conversations","traceId":"a7afb144-b705-47d1-aa6f-0d470061dfcb","source":"api-worker","timestamp":"2025-12-30T04:14:44.826Z","method":"OPTIONS","url":"http://local.test/v1/conversations","userAgent":null}

stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > OPTIONS -> 204 and includes CORS headers
{"level":"info","message":"Request completed","traceId":"a7afb144-b705-47d1-aa6f-0d470061dfcb","source":"api-worker","timestamp":"2025-12-30T04:14:44.827Z","status":204,"durationMs":0.856923999999708}

stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > GET -> includes strict CORS headers for allowed origin
{"level":"info","message":"Incoming request: GET http://local.test/v1/nope","traceId":"24c8ed68-da17-4bfb-aac3-affd5fa97e69","source":"api-worker","timestamp":"2025-12-30T04:14:44.828Z","method":"GET","url":"http://local.test/v1/nope","userAgent":null}

stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > GET -> includes strict CORS headers for allowed origin
{"level":"info","message":"Request completed","traceId":"24c8ed68-da17-4bfb-aac3-affd5fa97e69","source":"api-worker","timestamp":"2025-12-30T04:14:44.830Z","status":404,"durationMs":1.6304500000005646}

stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > GET -> does not include allow-origin for unknown origin
{"level":"info","message":"Incoming request: GET http://local.test/v1/nope","traceId":"8156d6c9-4e10-4743-a128-ee4b7f43f932","source":"api-worker","timestamp":"2025-12-30T04:14:44.831Z","method":"GET","url":"http://local.test/v1/nope","userAgent":null}

stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > GET -> does not include allow-origin for unknown origin
{"level":"info","message":"Request completed","traceId":"8156d6c9-4e10-4743-a128-ee4b7f43f932","source":"api-worker","timestamp":"2025-12-30T04:14:44.832Z","status":404,"durationMs":0.7421979999999166}

stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > Unknown route -> 404
{"level":"info","message":"Incoming request: GET http://local.test/v1/nope","traceId":"5d077cf3-5bf3-4938-a813-94d2554301e0","source":"api-worker","timestamp":"2025-12-30T04:14:44.833Z","method":"GET","url":"http://local.test/v1/nope","userAgent":null}

stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > Unknown route -> 404
{"level":"info","message":"Request completed","traceId":"5d077cf3-5bf3-4938-a813-94d2554301e0","source":"api-worker","timestamp":"2025-12-30T04:14:44.835Z","status":404,"durationMs":1.5333429999991495}

stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > WebSocket route -> 503 if ChatState not configured
{"level":"info","message":"Incoming request: GET http://local.test/v1/ws","traceId":"f00b9eee-fe7d-42cc-b37a-6826361dc347","source":"api-worker","timestamp":"2025-12-30T04:14:44.836Z","method":"GET","url":"http://local.test/v1/ws","userAgent":null}

stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > WebSocket route -> 503 if ChatState not configured
{"level":"info","message":"Request completed","traceId":"f00b9eee-fe7d-42cc-b37a-6826361dc347","source":"api-worker","timestamp":"2025-12-30T04:14:44.837Z","status":503,"durationMs":0.7596990000001824}

stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > WebSocket route -> delegates to Durable Object
{"level":"info","message":"Incoming request: GET http://local.test/v1/ws","traceId":"cc345c8d-1102-4f82-be9a-8f150e78afbd","source":"api-worker","timestamp":"2025-12-30T04:14:44.839Z","method":"GET","url":"http://local.test/v1/ws","userAgent":null}

stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > WebSocket route -> delegates to Durable Object
{"level":"info","message":"Request completed","traceId":"cc345c8d-1102-4f82-be9a-8f150e78afbd","source":"api-worker","timestamp":"2025-12-30T04:14:44.840Z","status":200,"durationMs":0.7350339999993594}

 ✓ apps/api-worker/test/app.wiring.test.ts (8 tests) 30ms
 ✓ test/guard-config-drift.test.ts (3 tests) 39ms
 ✓ apps/api-worker/src/lib/speechToText.test.ts (1 test) 21ms
 ✓ apps/api-worker/src/lib/textToSpeech.test.ts (1 test) 11ms
 ✓ apps/api-worker/test/controllers/EpisodicController.test.ts (9 tests) 15ms
 ✓ apps/api-worker/test/controllers/ChatController.test.ts (5 tests) 9ms
stdout | apps/api-worker/test/queue.test.ts > Queue Processor > should process semantic messages and generate embeddings
Generated embedding for semantic record rec-2 in 0.11ms

 ✓ apps/api-worker/test/queue.test.ts (3 tests) 8ms
 ✓ apps/api-worker/test/controllers/LogsController.test.ts (7 tests) 7ms
 ✓ apps/api-worker/test/controllers/SemanticController.test.ts (7 tests) 9ms
 ✓ apps/api-worker/test/controllers/PreferencesController.test.ts (6 tests) 10ms
 ✓ apps/api-worker/test/controllers/VoiceController.test.ts (4 tests) 7ms
 ✓ packages/policy/test/policy.test.ts (9 tests) 4ms
 ✓ apps/api-worker/test/controllers/IdentityController.test.ts (4 tests) 6ms
 ✓ apps/api-worker/test/controllers/MediaController.test.ts (5 tests) 4ms
 ✓ packages/memory-core/test/store.test.ts (6 tests) 3ms
 ✓ apps/api-worker/test/controllers/RelationshipsController.test.ts (2 tests) 10ms
 ✓ apps/api-worker/test/middleware/rateLimit.test.ts (5 tests) 4ms
 ✓ apps/api-worker/test/controllers/ConversationsController.test.ts (4 tests) 4ms
stdout | apps/api-worker/test/queue-job.test.ts > Queue Processor Jobs > should process embed job
Generated embedding for job job-456 in 0.02ms

 ✓ apps/api-worker/test/queue-job.test.ts (2 tests) 3ms
 ✓ apps/api-worker/test/middleware/errorHandler.test.ts (2 tests) 2ms
 ✓ apps/api-worker/test/controllers/AnalyticsController.test.ts (2 tests) 2ms
 ✓ apps/api-worker/src/lib/gemini.test.ts (1 test) 3ms
 ✓ apps/api-worker/test/controllers/JobsController.test.ts (3 tests) 3ms
 ✓ apps/api-worker/test/controllers/ReceiptsController.test.ts (2 tests) 6ms
 ✓ apps/api-worker/test/controllers/KnowledgeController.test.ts (2 tests) 2ms
 ✓ apps/api-worker/test/middleware/cors.test.ts (7 tests) 2ms
 ✓ apps/api-worker/test/controllers/InsightsController.test.ts (2 tests) 2ms
 ✓ apps/api-worker/src/lib/workersAiStt.test.ts (3 tests) 2ms
 ✓ packages/memory-core/test/hash.test.ts (6 tests) 3ms
stdout | apps/api-worker/test/middleware/context.test.ts > withContext Middleware > should attach logger and metrics to request
{"level":"info","message":"Incoming request: undefined undefined","traceId":"f646cab2-c5c7-4591-a0e6-3b06d362d50e","source":"api-worker","timestamp":"2025-12-30T04:14:46.037Z"}

stdout | apps/api-worker/test/middleware/context.test.ts > withContext Middleware > should use existing cf-ray as traceId if present
{"level":"info","message":"Incoming request: undefined undefined","traceId":"existing-trace-id","source":"api-worker","timestamp":"2025-12-30T04:14:46.037Z","userAgent":"existing-trace-id"}

 ✓ apps/api-worker/test/middleware/context.test.ts (2 tests) 2ms
 ✓ apps/api-worker/test/ai.test.ts (2 tests) 1ms
 ✓ apps/api-worker/test/controllers/RunbooksController.test.ts (2 tests) 2ms
 ✓ apps/api-worker/test/identity-preferences.test.ts (1 test) 1ms
 ✓ apps/api-worker/test/lib/wsDeny.test.ts (1 test) 1ms
 ✓ apps/api-worker/src/lib/vectorStore.test.ts (1 test) 1ms
 ✓ tools/mcp/aperion/src/paths.test.ts (2 tests) 2ms
 ✓ test/no-network.test.ts (1 test) 1ms
 ✓ apps/api-worker/test/hello.test.ts (2 tests) 1ms

 Test Files  44 passed (44)
      Tests  177 passed (177)
   Start at  04:14:29
   Duration  17.03s (transform 954ms, setup 191ms, collect 3.44s, tests 12.81s, environment 0ms, prepare 96ms)

