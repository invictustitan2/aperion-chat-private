
> aperion-chat-private@0.0.0 test:coverage /home/dreamboat/projects/aperion-chat-private
> pnpm test:coverage:node && pnpm test:coverage:web


> aperion-chat-private@0.0.0 test:coverage:node /home/dreamboat/projects/aperion-chat-private
> vitest run --coverage --environment node --exclude "apps/web/src/**/*.test.*" --exclude "apps/web/src/**/*.spec.*"


 RUN  v3.2.4 /home/dreamboat/projects/aperion-chat-private
      Coverage enabled with v8


 â›…ï¸ wrangler 4.55.0
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Resource location: local 

Use --remote if you want to access the remote instance.

âœ… No migrations to apply!
stdout | apps/api-worker/test/auth.test.ts > Authentication Middleware
Starting worker...

stdout | apps/api-worker/test/auth.test.ts > Authentication Middleware
Waiting for worker to be ready...
Will poll every 500ms for up to 12 attempts (6s total)

stderr | apps/api-worker/test/auth.test.ts > Authentication Middleware
[33mâ–² [43;33m[[43;30mWARNING[43;33m][0m [1mScheduled Workers are not automatically triggered during local development.[0m

  To manually trigger a scheduled event, run:
    curl "http://127.0.0.1:undefined/cdn-cgi/handler/scheduled"
  For more details, see [4mhttps://developers.cloudflare.com/workers/configuration/cron-triggers/#test-cron-triggers-locally[0m



stderr | apps/api-worker/test/auth.test.ts > Authentication Middleware
[33mâ–² [43;33m[[43;30mWARNING[43;33m][0m [1mAI bindings always access remote resources, and so may incur usage charges even in local dev. To suppress this warning, set `remote: true` for the binding definition in your configuration file.[0m


[33mâ–² [43;33m[[43;30mWARNING[43;33m][0m [1mVectorize Index bindings do not support local development, and so parts of your Worker may not work correctly. You may be able to set `remote: true` for the binding definition in your configuration file to access a remote version of the resource.[0m



stdout | apps/api-worker/test/auth.test.ts > Authentication Middleware
Attempt 1: Got response with status 401
âœ“ Worker ready after 1 attempts (~0.5s)

 âœ“ apps/api-worker/test/auth.test.ts (23 tests) 7124ms

 â›…ï¸ wrangler 4.55.0
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Resource location: local 

Use --remote if you want to access the remote instance.

âœ… No migrations to apply!
stderr | apps/api-worker/test/index.test.ts > API Worker Integration > Missing Authorization -> 401 with exact error shape
[33mâ–² [43;33m[[43;30mWARNING[43;33m][0m [1mAI bindings always access remote resources, and so may incur usage charges even in local dev. To suppress this warning, set `remote: true` for the binding definition in your configuration file.[0m


[33mâ–² [43;33m[[43;30mWARNING[43;33m][0m [1mVectorize Index bindings do not support local development, and so parts of your Worker may not work correctly. You may be able to set `remote: true` for the binding definition in your configuration file to access a remote version of the resource.[0m



 âœ“ apps/api-worker/test/index.test.ts (7 tests) 4988ms
   âœ“ API Worker Integration > Missing Authorization -> 401 with exact error shape  2296ms
 âœ“ apps/api-worker/test/lib/authContext.test.ts (5 tests) 800ms
   âœ“ getAuthContext (Cloudflare Access) > refreshes JWKS once when kid is unknown  500ms
 âœ“ test/verify-ci.test.ts (3 tests) 665ms
   âœ“ verify:ci > local mode does not hard-fail when Cloudflare account id is missing  411ms
 âœ“ test/cf-doctor.test.ts (1 test) 191ms
stderr | tools/cli/test/cli.test.ts > CLI Commands > verify > should not require AUTH_TOKEN in access mode
âš ï¸  Server did not return X-Aperion-Auth-Fingerprint. The API worker may be on an older version.

 âœ“ tools/cli/test/cli.test.ts (4 tests) 113ms
 âœ“ test/guard-config-drift.test.ts (3 tests) 66ms
stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > Missing Authorization -> 401 (auth middleware wired)
{"level":"info","message":"Incoming request: GET http://local.test/v1/conversations","traceId":"a5e9231e-89ca-4a14-bd17-0f498a4719f8","source":"api-worker","timestamp":"2026-01-02T10:08:16.882Z","method":"GET","url":"http://local.test/v1/conversations","userAgent":null}

stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > Missing Authorization -> 401 (auth middleware wired)
{"level":"warn","message":"Auth outcome","traceId":"a5e9231e-89ca-4a14-bd17-0f498a4719f8","source":"api-worker","timestamp":"2026-01-02T10:08:16.883Z","event":"auth.outcome","outcome":"deny","mode":"token","method":"GET","path":"/v1/conversations","status":401,"reason":"Unauthorized (missing bearer token)","durationMs":0}

stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > Missing Authorization -> 401 (auth middleware wired)
{"level":"info","message":"Request completed","traceId":"a5e9231e-89ca-4a14-bd17-0f498a4719f8","source":"api-worker","timestamp":"2026-01-02T10:08:16.884Z","status":401,"durationMs":2.2767260000000533}

stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > Access mode missing assertion -> 401 (fail-closed canary)
{"level":"info","message":"Incoming request: GET http://local.test/v1/conversations","traceId":"8dd41109-0f06-4bd6-a29c-8ad0250c1776","source":"api-worker","timestamp":"2026-01-02T10:08:16.886Z","method":"GET","url":"http://local.test/v1/conversations","userAgent":null}

stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > Access mode missing assertion -> 401 (fail-closed canary)
{"level":"warn","message":"Auth outcome","traceId":"8dd41109-0f06-4bd6-a29c-8ad0250c1776","source":"api-worker","timestamp":"2026-01-02T10:08:16.886Z","event":"auth.outcome","outcome":"deny","mode":"access","method":"GET","path":"/v1/conversations","status":401,"reason":"Missing Access assertion (expected CF-Access-Jwt-Assertion header or CF_Authorization cookie)","durationMs":0}

stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > Access mode missing assertion -> 401 (fail-closed canary)
{"level":"info","message":"Request completed","traceId":"8dd41109-0f06-4bd6-a29c-8ad0250c1776","source":"api-worker","timestamp":"2026-01-02T10:08:16.886Z","status":401,"durationMs":0.7624759999998787}

stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > OPTIONS -> 204 and includes CORS headers
{"level":"info","message":"Incoming request: OPTIONS http://local.test/v1/conversations","traceId":"2e9f7954-9c53-43c3-834c-aee27e584b9b","source":"api-worker","timestamp":"2026-01-02T10:08:16.889Z","method":"OPTIONS","url":"http://local.test/v1/conversations","userAgent":null}

stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > OPTIONS -> 204 and includes CORS headers
{"level":"info","message":"Request completed","traceId":"2e9f7954-9c53-43c3-834c-aee27e584b9b","source":"api-worker","timestamp":"2026-01-02T10:08:16.891Z","status":204,"durationMs":1.49647399999958}

stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > GET -> includes strict CORS headers for allowed origin
{"level":"info","message":"Incoming request: GET http://local.test/v1/nope","traceId":"283abb08-0aa5-443a-8555-9a6d8deb1f89","source":"api-worker","timestamp":"2026-01-02T10:08:16.893Z","method":"GET","url":"http://local.test/v1/nope","userAgent":null}

stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > GET -> includes strict CORS headers for allowed origin
{"level":"info","message":"Request completed","traceId":"283abb08-0aa5-443a-8555-9a6d8deb1f89","source":"api-worker","timestamp":"2026-01-02T10:08:16.893Z","status":404,"durationMs":0.8829069999992498}

stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > GET -> does not include allow-origin for unknown origin
{"level":"info","message":"Incoming request: GET http://local.test/v1/nope","traceId":"d02ab5a4-c7cd-4f1a-ad26-d00056d14e09","source":"api-worker","timestamp":"2026-01-02T10:08:16.895Z","method":"GET","url":"http://local.test/v1/nope","userAgent":null}

stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > GET -> does not include allow-origin for unknown origin
{"level":"info","message":"Request completed","traceId":"d02ab5a4-c7cd-4f1a-ad26-d00056d14e09","source":"api-worker","timestamp":"2026-01-02T10:08:16.896Z","status":404,"durationMs":0.7093199999981152}

stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > Unknown route -> 404
{"level":"info","message":"Incoming request: GET http://local.test/v1/nope","traceId":"65cc8e2f-1b66-4bad-b669-0f148e733c5d","source":"api-worker","timestamp":"2026-01-02T10:08:16.897Z","method":"GET","url":"http://local.test/v1/nope","userAgent":null}

stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > Unknown route -> 404
{"level":"info","message":"Request completed","traceId":"65cc8e2f-1b66-4bad-b669-0f148e733c5d","source":"api-worker","timestamp":"2026-01-02T10:08:16.897Z","status":404,"durationMs":0.5386609999986831}

stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > WebSocket route -> 503 if ChatState not configured
{"level":"info","message":"Incoming request: GET http://local.test/v1/ws","traceId":"71017af0-984a-4cfb-bd53-2eab43da8426","source":"api-worker","timestamp":"2026-01-02T10:08:16.898Z","method":"GET","url":"http://local.test/v1/ws","userAgent":null}

stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > WebSocket route -> 503 if ChatState not configured
{"level":"info","message":"Request completed","traceId":"71017af0-984a-4cfb-bd53-2eab43da8426","source":"api-worker","timestamp":"2026-01-02T10:08:16.899Z","status":503,"durationMs":0.9260119999999006}

stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > WebSocket route -> delegates to Durable Object
{"level":"info","message":"Incoming request: GET http://local.test/v1/ws","traceId":"887def7c-3760-4131-ba8d-9b82e191d0f2","source":"api-worker","timestamp":"2026-01-02T10:08:16.901Z","method":"GET","url":"http://local.test/v1/ws","userAgent":null}

stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > WebSocket route -> delegates to Durable Object
{"level":"info","message":"Request completed","traceId":"887def7c-3760-4131-ba8d-9b82e191d0f2","source":"api-worker","timestamp":"2026-01-02T10:08:16.901Z","status":200,"durationMs":0.5911899999991874}

 âœ“ apps/api-worker/test/app.wiring.test.ts (8 tests) 24ms
 âœ“ apps/api-worker/src/lib/textToSpeech.test.ts (1 test) 11ms
 âœ“ apps/api-worker/src/lib/speechToText.test.ts (1 test) 12ms
 âœ“ apps/api-worker/test/controllers/EpisodicController.test.ts (9 tests) 13ms
 âœ“ apps/api-worker/test/controllers/ChatController.test.ts (5 tests) 12ms
stdout | apps/api-worker/test/queue.test.ts > Queue Processor > should process semantic messages and generate embeddings
Generated embedding for semantic record rec-2 in 0.12ms

stderr | apps/api-worker/test/queue.test.ts > Queue Processor > should retry if processing fails
Failed to process message msg-3: Error: DB Error
    at run [90m(/home/dreamboat/projects/aperion-chat-private/[39mapps/api-worker/test/queue.test.ts:98:15[90m)[39m
    at Object.run [90m(/home/dreamboat/projects/aperion-chat-private/[39mapps/api-worker/test/bindings/mockBindings.ts:138:30[90m)[39m
    at processEpisodic [90m(/home/dreamboat/projects/aperion-chat-private/[39mapps/api-worker/src/lib/queue-processor.ts:93:6[90m)[39m
    at processMemoryBatch [90m(/home/dreamboat/projects/aperion-chat-private/[39mapps/api-worker/src/lib/queue-processor.ts:39:15[90m)[39m
    at [90m/home/dreamboat/projects/aperion-chat-private/[39mapps/api-worker/test/queue.test.ts:120:11
    at [90mfile:///home/dreamboat/projects/aperion-chat-private/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:155:11
    at [90mfile:///home/dreamboat/projects/aperion-chat-private/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:26
    at [90mfile:///home/dreamboat/projects/aperion-chat-private/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1897:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///home/dreamboat/projects/aperion-chat-private/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1863:10[90m)[39m

 âœ“ apps/api-worker/test/queue.test.ts (3 tests) 8ms
 âœ“ apps/api-worker/test/controllers/SemanticController.test.ts (7 tests) 8ms
 âœ“ packages/memory-core/test/store.test.ts (6 tests) 4ms
 âœ“ apps/api-worker/test/controllers/LogsController.test.ts (7 tests) 7ms
 âœ“ apps/api-worker/test/controllers/VoiceController.test.ts (4 tests) 7ms
 âœ“ apps/api-worker/test/controllers/RelationshipsController.test.ts (2 tests) 5ms
 âœ“ apps/api-worker/test/controllers/IdentityController.test.ts (4 tests) 6ms
 âœ“ apps/api-worker/test/controllers/PreferencesController.test.ts (6 tests) 5ms
 âœ“ apps/api-worker/test/controllers/ReceiptsController.test.ts (2 tests) 3ms
 âœ“ apps/api-worker/test/preferences-theme.test.ts (3 tests) 4ms
 âœ“ apps/api-worker/test/middleware/rateLimit.test.ts (5 tests) 4ms
 âœ“ apps/api-worker/test/controllers/ConversationsController.test.ts (4 tests) 4ms
stdout | apps/api-worker/test/queue-job.test.ts > Queue Processor Jobs > should process embed job
Generated embedding for job job-456 in 0.03ms

 âœ“ apps/api-worker/test/queue-job.test.ts (2 tests) 3ms
 âœ“ packages/policy/test/policy.test.ts (9 tests) 4ms
 âœ“ apps/api-worker/test/controllers/MediaController.test.ts (5 tests) 6ms
 âœ“ apps/api-worker/test/controllers/JobsController.test.ts (3 tests) 3ms
 âœ“ apps/api-worker/test/controllers/AnalyticsController.test.ts (2 tests) 2ms
 âœ“ apps/api-worker/test/middleware/errorHandler.test.ts (2 tests) 5ms
 âœ“ apps/api-worker/test/controllers/InsightsController.test.ts (2 tests) 2ms
 âœ“ apps/api-worker/test/middleware/cors.test.ts (7 tests) 5ms
 âœ“ apps/api-worker/src/lib/gemini.test.ts (1 test) 3ms
 âœ“ apps/api-worker/src/lib/workersAiStt.test.ts (3 tests) 2ms
stdout | apps/api-worker/test/middleware/context.test.ts > withContext Middleware > should attach logger and metrics to request
{"level":"info","message":"Incoming request: undefined undefined","traceId":"9c261a90-ab5d-4042-ad53-bcdfbaf69864","source":"api-worker","timestamp":"2026-01-02T10:08:18.607Z"}

stdout | apps/api-worker/test/middleware/context.test.ts > withContext Middleware > should use existing cf-ray as traceId if present
{"level":"info","message":"Incoming request: undefined undefined","traceId":"existing-trace-id","source":"api-worker","timestamp":"2026-01-02T10:08:18.608Z","userAgent":"existing-trace-id"}

 âœ“ apps/api-worker/test/middleware/context.test.ts (2 tests) 2ms
 âœ“ test/workflows_deploy_web_path_b.test.ts (4 tests) 2ms
 âœ“ apps/api-worker/test/controllers/KnowledgeController.test.ts (2 tests) 2ms
 âœ“ apps/api-worker/test/controllers/RunbooksController.test.ts (2 tests) 2ms
 âœ“ packages/memory-core/test/hash.test.ts (6 tests) 2ms
 âœ“ apps/api-worker/test/ai.test.ts (2 tests) 2ms
 âœ“ test/docs_path_b_defaults.test.ts (2 tests) 2ms
 âœ“ apps/api-worker/test/identity-preferences.test.ts (1 test) 1ms
 âœ“ test/docs_deployment_contract.test.ts (2 tests) 1ms
 âœ“ tools/mcp/aperion/src/paths.test.ts (2 tests) 1ms
 âœ“ apps/api-worker/src/lib/vectorStore.test.ts (1 test) 1ms
 âœ“ apps/api-worker/test/lib/wsDeny.test.ts (1 test) 1ms
 âœ“ test/no-network.test.ts (1 test) 1ms
 âœ“ apps/api-worker/test/hello.test.ts (2 tests) 1ms

 Test Files  48 passed (48)
      Tests  189 passed (189)
   Start at  10:07:59
   Duration  21.10s (transform 939ms, setup 176ms, collect 3.46s, tests 14.14s, environment 0ms, prepare 113ms)

 % Coverage report from v8

=============================== Coverage summary ===============================
Statements   : 19.59% ( 2460/12556 )
Branches     : 63.17% ( 446/706 )
Functions    : 64.74% ( 202/312 )
Lines        : 19.59% ( 2460/12556 )
================================================================================
ERROR: Coverage for lines (19.59%) does not meet global threshold (45%)
ERROR: Coverage for statements (19.59%) does not meet global threshold (45%)
â€‰ELIFECYCLEâ€‰ Command failed with exit code 1.
â€‰ELIFECYCLEâ€‰ Command failed with exit code 1.
