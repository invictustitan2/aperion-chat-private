
> aperion-chat-private@0.0.0 test:coverage:node /home/dreamboat/projects/aperion-chat-private
> vitest run --coverage -c vitest.coverage.node.config.ts


 RUN  v3.2.4 /home/dreamboat/projects/aperion-chat-private
      Coverage enabled with v8


 â›…ï¸ wrangler 4.55.0
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Resource location: local 

Use --remote if you want to access the remote instance.

âœ… No migrations to apply!
stdout | apps/api-worker/test/auth.test.ts > Authentication Middleware
Starting worker...

stdout | apps/api-worker/test/auth.test.ts > Authentication Middleware
Waiting for worker to be ready...
Will poll every 500ms for up to 12 attempts (6s total)

stderr | apps/api-worker/test/auth.test.ts > Authentication Middleware
[33mâ–² [43;33m[[43;30mWARNING[43;33m][0m [1mScheduled Workers are not automatically triggered during local development.[0m

  To manually trigger a scheduled event, run:
    curl "http://127.0.0.1:undefined/cdn-cgi/handler/scheduled"
  For more details, see [4mhttps://developers.cloudflare.com/workers/configuration/cron-triggers/#test-cron-triggers-locally[0m



stderr | apps/api-worker/test/auth.test.ts > Authentication Middleware
[33mâ–² [43;33m[[43;30mWARNING[43;33m][0m [1mAI bindings always access remote resources, and so may incur usage charges even in local dev. To suppress this warning, set `remote: true` for the binding definition in your configuration file.[0m


[33mâ–² [43;33m[[43;30mWARNING[43;33m][0m [1mVectorize Index bindings do not support local development, and so parts of your Worker may not work correctly. You may be able to set `remote: true` for the binding definition in your configuration file to access a remote version of the resource.[0m



stdout | apps/api-worker/test/auth.test.ts > Authentication Middleware
Attempt 1: Got response with status 401
âœ“ Worker ready after 1 attempts (~0.5s)

 âœ“ apps/api-worker/test/auth.test.ts (23 tests) 6031ms

 â›…ï¸ wrangler 4.55.0
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Resource location: local 

Use --remote if you want to access the remote instance.

âœ… No migrations to apply!
stderr | apps/api-worker/test/index.test.ts > API Worker Integration > Missing Authorization -> 401 with exact error shape
[33mâ–² [43;33m[[43;30mWARNING[43;33m][0m [1mAI bindings always access remote resources, and so may incur usage charges even in local dev. To suppress this warning, set `remote: true` for the binding definition in your configuration file.[0m


[33mâ–² [43;33m[[43;30mWARNING[43;33m][0m [1mVectorize Index bindings do not support local development, and so parts of your Worker may not work correctly. You may be able to set `remote: true` for the binding definition in your configuration file to access a remote version of the resource.[0m



 âœ“ apps/api-worker/test/index.test.ts (7 tests) 4830ms
   âœ“ API Worker Integration > Missing Authorization -> 401 with exact error shape  2154ms
 âœ“ apps/api-worker/test/lib/authContext.test.ts (5 tests) 1343ms
   âœ“ getAuthContext (Cloudflare Access) > refreshes JWKS once when kid is unknown  871ms
 âœ“ test/verify-ci.test.ts (3 tests) 736ms
   âœ“ verify:ci > local mode does not hard-fail when Cloudflare account id is missing  451ms
 âœ“ test/cf-doctor.test.ts (1 test) 281ms
 âœ“ apps/api-worker/test/services/ChatService.test.ts (2 tests) 163ms
stderr | tools/cli/test/cli.test.ts > CLI Commands > verify > should not require AUTH_TOKEN in access mode
âš ï¸  Server did not return X-Aperion-Auth-Fingerprint. The API worker may be on an older version.

 âœ“ tools/cli/test/cli.test.ts (4 tests) 114ms
 âœ“ test/guard-config-drift.test.ts (3 tests) 38ms
 âœ“ apps/api-worker/test/workerEntrypoint.test.ts (3 tests) 46ms
 âœ“ apps/api-worker/src/lib/googleAuth.test.ts (3 tests) 27ms
stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > Missing Authorization -> 401 (auth middleware wired)
{"level":"info","message":"Incoming request: GET http://local.test/v1/conversations","traceId":"c888a8ec-0edf-4208-bba9-201c4dfce579","source":"api-worker","timestamp":"2026-01-02T12:11:22.608Z","method":"GET","url":"http://local.test/v1/conversations","userAgent":null}

stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > Missing Authorization -> 401 (auth middleware wired)
{"level":"warn","message":"Auth outcome","traceId":"c888a8ec-0edf-4208-bba9-201c4dfce579","source":"api-worker","timestamp":"2026-01-02T12:11:22.609Z","event":"auth.outcome","outcome":"deny","mode":"token","method":"GET","path":"/v1/conversations","status":401,"reason":"Unauthorized (missing bearer token)","durationMs":0}

stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > Missing Authorization -> 401 (auth middleware wired)
{"level":"info","message":"Request completed","traceId":"c888a8ec-0edf-4208-bba9-201c4dfce579","source":"api-worker","timestamp":"2026-01-02T12:11:22.611Z","status":401,"durationMs":2.683757999999216}

stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > Access mode missing assertion -> 401 (fail-closed canary)
{"level":"info","message":"Incoming request: GET http://local.test/v1/conversations","traceId":"b8bc1fe0-196f-4a11-9abf-0bd17914ff85","source":"api-worker","timestamp":"2026-01-02T12:11:22.612Z","method":"GET","url":"http://local.test/v1/conversations","userAgent":null}

stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > Access mode missing assertion -> 401 (fail-closed canary)
{"level":"warn","message":"Auth outcome","traceId":"b8bc1fe0-196f-4a11-9abf-0bd17914ff85","source":"api-worker","timestamp":"2026-01-02T12:11:22.613Z","event":"auth.outcome","outcome":"deny","mode":"access","method":"GET","path":"/v1/conversations","status":401,"reason":"Missing Access assertion (expected CF-Access-Jwt-Assertion header or CF_Authorization cookie)","durationMs":0}

stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > Access mode missing assertion -> 401 (fail-closed canary)
{"level":"info","message":"Request completed","traceId":"b8bc1fe0-196f-4a11-9abf-0bd17914ff85","source":"api-worker","timestamp":"2026-01-02T12:11:22.614Z","status":401,"durationMs":1.5930630000002566}

stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > OPTIONS -> 204 and includes CORS headers
{"level":"info","message":"Incoming request: OPTIONS http://local.test/v1/conversations","traceId":"03649737-a4d0-4bd2-9cb1-e03b3a66fa71","source":"api-worker","timestamp":"2026-01-02T12:11:22.618Z","method":"OPTIONS","url":"http://local.test/v1/conversations","userAgent":null}

stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > OPTIONS -> 204 and includes CORS headers
{"level":"info","message":"Request completed","traceId":"03649737-a4d0-4bd2-9cb1-e03b3a66fa71","source":"api-worker","timestamp":"2026-01-02T12:11:22.620Z","status":204,"durationMs":1.5443010000017239}

stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > GET -> includes strict CORS headers for allowed origin
{"level":"info","message":"Incoming request: GET http://local.test/v1/nope","traceId":"ca95ca49-8e1d-48db-8bb5-0f7d554f0d0e","source":"api-worker","timestamp":"2026-01-02T12:11:22.622Z","method":"GET","url":"http://local.test/v1/nope","userAgent":null}

stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > GET -> includes strict CORS headers for allowed origin
{"level":"info","message":"Request completed","traceId":"ca95ca49-8e1d-48db-8bb5-0f7d554f0d0e","source":"api-worker","timestamp":"2026-01-02T12:11:22.623Z","status":404,"durationMs":0.9763329999987036}

stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > GET -> does not include allow-origin for unknown origin
{"level":"info","message":"Incoming request: GET http://local.test/v1/nope","traceId":"cd5d1962-90e0-4369-86c7-14c77cfadb7d","source":"api-worker","timestamp":"2026-01-02T12:11:22.624Z","method":"GET","url":"http://local.test/v1/nope","userAgent":null}

stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > GET -> does not include allow-origin for unknown origin
{"level":"info","message":"Request completed","traceId":"cd5d1962-90e0-4369-86c7-14c77cfadb7d","source":"api-worker","timestamp":"2026-01-02T12:11:22.625Z","status":404,"durationMs":0.8382369999999355}

stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > Unknown route -> 404
{"level":"info","message":"Incoming request: GET http://local.test/v1/nope","traceId":"d0541518-73a2-4304-9f45-6b4898c3a3a2","source":"api-worker","timestamp":"2026-01-02T12:11:22.627Z","method":"GET","url":"http://local.test/v1/nope","userAgent":null}

stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > Unknown route -> 404
{"level":"info","message":"Request completed","traceId":"d0541518-73a2-4304-9f45-6b4898c3a3a2","source":"api-worker","timestamp":"2026-01-02T12:11:22.628Z","status":404,"durationMs":0.6821899999995367}

stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > WebSocket route -> 503 if ChatState not configured
{"level":"info","message":"Incoming request: GET http://local.test/v1/ws","traceId":"1354daed-995c-452f-ac71-8101f31ceef1","source":"api-worker","timestamp":"2026-01-02T12:11:22.629Z","method":"GET","url":"http://local.test/v1/ws","userAgent":null}

stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > WebSocket route -> 503 if ChatState not configured
{"level":"info","message":"Request completed","traceId":"1354daed-995c-452f-ac71-8101f31ceef1","source":"api-worker","timestamp":"2026-01-02T12:11:22.630Z","status":503,"durationMs":1.278835999997682}

stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > WebSocket route -> delegates to Durable Object
{"level":"info","message":"Incoming request: GET http://local.test/v1/ws","traceId":"a7f1de77-9e6c-4199-9c51-ba78ec0da99c","source":"api-worker","timestamp":"2026-01-02T12:11:22.632Z","method":"GET","url":"http://local.test/v1/ws","userAgent":null}

stdout | apps/api-worker/test/app.wiring.test.ts > API Worker wiring (in-process coverage) > WebSocket route -> delegates to Durable Object
{"level":"info","message":"Request completed","traceId":"a7f1de77-9e6c-4199-9c51-ba78ec0da99c","source":"api-worker","timestamp":"2026-01-02T12:11:22.633Z","status":200,"durationMs":0.6620609999990847}

 âœ“ apps/api-worker/test/app.wiring.test.ts (8 tests) 29ms
 âœ“ apps/api-worker/src/lib/speechToText.test.ts (1 test) 18ms
 âœ“ tools/cli/test/seed.test.ts (4 tests) 15ms
 âœ“ apps/api-worker/src/lib/renderer.test.ts (2 tests) 16ms
 âœ“ apps/api-worker/src/lib/textToSpeech.test.ts (1 test) 17ms
 âœ“ apps/api-worker/test/services/RelationshipsService.test.ts (4 tests) 10ms
 âœ“ apps/api-worker/test/middleware/cors.test.ts (7 tests) 3ms
 âœ“ apps/api-worker/test/controllers/EpisodicController.test.ts (9 tests) 14ms
stdout | apps/api-worker/test/queue.test.ts > Queue Processor > should process semantic messages and generate embeddings
Generated embedding for semantic record rec-2 in 0.06ms

stderr | apps/api-worker/test/queue.test.ts > Queue Processor > should retry if processing fails
Failed to process message msg-3: Error: DB Error
    at run [90m(/home/dreamboat/projects/aperion-chat-private/[39mapps/api-worker/test/queue.test.ts:98:15[90m)[39m
    at Object.run [90m(/home/dreamboat/projects/aperion-chat-private/[39mapps/api-worker/test/bindings/mockBindings.ts:138:30[90m)[39m
    at processEpisodic [90m(/home/dreamboat/projects/aperion-chat-private/[39mapps/api-worker/src/lib/queue-processor.ts:93:6[90m)[39m
    at processMemoryBatch [90m(/home/dreamboat/projects/aperion-chat-private/[39mapps/api-worker/src/lib/queue-processor.ts:39:15[90m)[39m
    at [90m/home/dreamboat/projects/aperion-chat-private/[39mapps/api-worker/test/queue.test.ts:120:11
    at [90mfile:///home/dreamboat/projects/aperion-chat-private/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:155:11
    at [90mfile:///home/dreamboat/projects/aperion-chat-private/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:26
    at [90mfile:///home/dreamboat/projects/aperion-chat-private/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1897:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///home/dreamboat/projects/aperion-chat-private/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1863:10[90m)[39m

 âœ“ apps/api-worker/test/queue.test.ts (3 tests) 10ms
 âœ“ apps/api-worker/test/controllers/SemanticController.test.ts (7 tests) 9ms
 âœ“ apps/api-worker/src/lib/ai.branches.test.ts (4 tests) 10ms
 âœ“ apps/api-worker/test/controllers/ChatController.test.ts (5 tests) 9ms
 âœ“ apps/api-worker/test/services/KnowledgeService.test.ts (5 tests) 5ms
 âœ“ apps/api-worker/test/controllers/VoiceController.test.ts (4 tests) 9ms
 âœ“ apps/api-worker/test/controllers/LogsController.test.ts (7 tests) 9ms
 âœ“ packages/memory-core/test/store.test.ts (6 tests) 4ms
 âœ“ packages/policy/test/policy.test.ts (9 tests) 4ms
stdout | apps/api-worker/test/queue-job.test.ts > Queue Processor Jobs > should process embed job
Generated embedding for job job-456 in 0.04ms

 âœ“ apps/api-worker/test/queue-job.test.ts (2 tests) 5ms
 âœ“ apps/api-worker/test/preferences-theme.test.ts (3 tests) 6ms
 âœ“ tools/mcp/aperion/test/memoryIngest.test.ts (4 tests) 12ms
stderr | tools/cli/test/export.test.ts > exportData > fetches endpoints and writes jsonl when output provided
âŒ Failed to fetch identity: Bad

stdout | tools/cli/test/export.test.ts > exportData > handles fetch throw without crashing
Exporting data...
Fetching episodic...

stdout | tools/cli/test/export.test.ts > exportData > handles fetch throw without crashing
Fetching identity...

 â¯ tools/cli/test/export.test.ts (3 tests | 2 failed) 9ms
   âœ“ exportData > exits when AUTH_TOKEN missing 3ms
   Ã— exportData > fetches endpoints and writes jsonl when output provided 4ms
     â†’ default.writeFile is not a function
   Ã— exportData > handles fetch throw without crashing 2ms
     â†’ default.writeFile is not a function
stdout | apps/api-worker/test/do/ChatState.test.ts > ChatState Durable Object > denies websocket upgrade when unauthenticated
{"level":"info","message":"WS upgrade outcome","source":"api-worker","component":"do.ChatState","event":"ws.upgrade","outcome":"deny","path":"/v1/ws","status":401,"mode":"token","reason":"Unauthorized","closeCode":1008}

 âœ“ apps/api-worker/test/do/ChatState.test.ts (2 tests) 11ms
 âœ“ apps/api-worker/test/controllers/PreferencesController.test.ts (6 tests) 6ms
 âœ“ apps/api-worker/test/controllers/RelationshipsController.test.ts (2 tests) 4ms
 âœ“ apps/api-worker/test/controllers/IdentityController.test.ts (4 tests) 6ms
 âœ“ apps/api-worker/test/services/AnalyticsService.test.ts (1 test) 6ms
 âœ“ tools/mcp/aperion/test/index.test.ts (5 tests) 4ms
 âœ“ apps/api-worker/test/controllers/ReceiptsController.test.ts (2 tests) 3ms
 âœ“ apps/api-worker/test/services/EpisodicService.test.ts (4 tests) 4ms
 âœ“ apps/api-worker/test/controllers/ConversationsController.test.ts (4 tests) 5ms
 âœ“ apps/api-worker/test/middleware/rateLimit.test.ts (5 tests) 5ms
 âœ“ apps/api-worker/test/services/SemanticService.test.ts (4 tests) 6ms
 âœ“ apps/api-worker/test/controllers/MediaController.test.ts (5 tests) 4ms
 âœ“ apps/api-worker/test/services/ConversationsService.test.ts (4 tests) 4ms
 âœ“ apps/api-worker/test/services/IdentityService.test.ts (3 tests) 3ms
 âœ“ apps/api-worker/test/controllers/JobsController.test.ts (3 tests) 3ms
 âœ“ apps/api-worker/test/controllers/InsightsController.test.ts (2 tests) 3ms
 âœ“ apps/api-worker/src/lib/workersAiStt.test.ts (3 tests) 3ms
 âœ“ apps/api-worker/src/lib/gemini.test.ts (1 test) 3ms
stdout | apps/api-worker/test/middleware/context.test.ts > withContext Middleware > should attach logger and metrics to request
{"level":"info","message":"Incoming request: undefined undefined","traceId":"e7d35960-f127-4b43-a0a1-acedbb07f3e8","source":"api-worker","timestamp":"2026-01-02T12:11:26.034Z"}

stdout | apps/api-worker/test/middleware/context.test.ts > withContext Middleware > should use existing cf-ray as traceId if present
{"level":"info","message":"Incoming request: undefined undefined","traceId":"existing-trace-id","source":"api-worker","timestamp":"2026-01-02T12:11:26.035Z","userAgent":"existing-trace-id"}

 âœ“ apps/api-worker/test/middleware/context.test.ts (2 tests) 2ms
 âœ“ packages/shared/test/hash.test.ts (3 tests) 2ms
 âœ“ apps/api-worker/test/controllers/KnowledgeController.test.ts (2 tests) 3ms
 âœ“ apps/api-worker/test/controllers/AnalyticsController.test.ts (2 tests) 4ms
 âœ“ apps/api-worker/test/middleware/errorHandler.test.ts (2 tests) 3ms
 âœ“ packages/memory-core/test/hash.test.ts (6 tests) 2ms
 âœ“ test/docs_deployment_contract.test.ts (2 tests) 1ms
 âœ“ apps/api-worker/test/controllers/RunbooksController.test.ts (2 tests) 2ms
 âœ“ test/workflows_deploy_web_path_b.test.ts (4 tests) 2ms
 âœ“ test/docs_path_b_defaults.test.ts (2 tests) 2ms
 âœ“ apps/api-worker/test/ai.test.ts (2 tests) 2ms
 âœ“ test/no-network.test.ts (1 test) 3ms
 âœ“ apps/api-worker/test/lib/wsDeny.test.ts (1 test) 1ms
 âœ“ apps/api-worker/test/identity-preferences.test.ts (1 test) 1ms
 âœ“ tools/mcp/aperion/src/paths.test.ts (2 tests) 1ms
 âœ“ apps/api-worker/src/lib/vectorStore.test.ts (1 test) 1ms
 âœ“ apps/api-worker/test/hello.test.ts (2 tests) 1ms
 âœ“ packages/shared/test/shortcuts.test.ts (1 test) 1ms

â¯â¯â¯â¯â¯â¯â¯ Failed Tests 2 â¯â¯â¯â¯â¯â¯â¯

 FAIL  tools/cli/test/export.test.ts > exportData > fetches endpoints and writes jsonl when output provided
TypeError: default.writeFile is not a function
 â¯ Module.exportData tools/cli/src/commands/export.ts:61:14
     59| 
     60|   if (options.output) {
     61|     await fs.writeFile(options.output, jsonl);
       |              ^
     62|     console.log(
     63|       chalk.green(`âœ“ Exported ${allData.length} records to ${options.oâ€¦
 â¯ tools/cli/test/export.test.ts:66:5

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[1/2]â¯

 FAIL  tools/cli/test/export.test.ts > exportData > handles fetch throw without crashing
TypeError: default.writeFile is not a function
 â¯ Module.exportData tools/cli/src/commands/export.ts:61:14
     59| 
     60|   if (options.output) {
     61|     await fs.writeFile(options.output, jsonl);
       |              ^
     62|     console.log(
     63|       chalk.green(`âœ“ Exported ${allData.length} records to ${options.oâ€¦
 â¯ tools/cli/test/export.test.ts:89:5

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[2/2]â¯


 Test Files  1 failed | 66 passed (67)
      Tests  2 failed | 248 passed (250)
   Start at  12:11:04
   Duration  23.38s (transform 1.33s, setup 263ms, collect 4.67s, tests 13.95s, environment 0ms, prepare 128ms)

â€‰ELIFECYCLEâ€‰ Command failed with exit code 1.

> aperion-chat-private@0.0.0 test:coverage:web /home/dreamboat/projects/aperion-chat-private
> vitest run --coverage -c vitest.coverage.web.config.ts --dir apps/web/src


 RUN  v3.2.4 /home/dreamboat/projects/aperion-chat-private
      Coverage enabled with v8

 âœ“ apps/web/src/pages/Chat.test.tsx (17 tests) 3078ms
   âœ“ Chat Page > deletes a conversation  645ms
   âœ“ Chat Page > renames a conversation  381ms
   âœ“ Chat Page > edits a message  392ms
   âœ“ Mobile Navigation > opens conversations drawer and selects a conversation  492ms
 âœ“ apps/web/src/components/MessageBubble.test.tsx (13 tests) 1090ms
stderr | apps/web/src/pages/Memory.test.tsx > Memory Page > renders the header and default tab (Identity)
Query data cannot be undefined. Please make sure to return a value other than undefined from your query function. Affected query key: ["episodic"]

 âœ“ apps/web/src/pages/Memory.test.tsx (6 tests) 858ms
 âœ“ apps/web/src/pages/Insights.test.tsx (5 tests) 814ms
   âœ“ Insights Page > handles queued job and polls for result  765ms
 âœ“ apps/web/src/components/ConversationItem.test.tsx (11 tests) 537ms
 âœ“ apps/web/src/pages/Logs.test.tsx (9 tests) 398ms
 âœ“ apps/web/src/components/CommandPalette.test.tsx (6 tests) 347ms
 âœ“ apps/web/src/pages/Analytics.test.tsx (5 tests) 167ms
 âœ“ apps/web/src/pages/Identity.test.tsx (7 tests) 190ms
 âœ“ apps/web/src/pages/Settings.test.tsx (7 tests) 197ms
 âœ“ apps/web/src/hooks/useWebSocket.test.tsx (2 tests) 137ms
 âœ“ apps/web/src/components/MessageContent.test.tsx (5 tests) 114ms
 âœ“ apps/web/src/pages/SystemStatus.test.tsx (4 tests) 86ms
 âœ“ apps/web/src/components/Layout.test.tsx (3 tests | 1 skipped) 119ms
 âœ“ apps/web/src/components/ChatInput.test.tsx (19 tests) 112ms
 âœ“ apps/web/src/pages/Knowledge.test.tsx (6 tests) 80ms
 âœ“ apps/web/src/components/ErrorBoundary.test.tsx (2 tests) 61ms
 âœ“ apps/web/src/pages/Receipts.test.tsx (4 tests) 48ms
 âœ“ apps/web/src/components/EmptyStates.test.tsx (9 tests) 42ms
 âœ“ apps/web/src/components/ConversationSearch.test.tsx (6 tests) 31ms
 â¯ apps/web/src/App.test.tsx (2 tests | 2 failed) 51ms
   Ã— App > toggles command palette on Cmd/Ctrl+K and supports onClose 36ms
     â†’ Cannot read properties of undefined (reading 'addEventListener')
   Ã— App > prevents default on Cmd/Ctrl+K 15ms
     â†’ Cannot read properties of undefined (reading 'addEventListener')
 âœ“ apps/web/src/contexts/ThemeContext.test.tsx (2 tests) 79ms
 âœ“ apps/web/src/lib/api.test.ts (9 tests) 29ms
stdout | apps/web/src/lib/websocket.test.ts > WebSocketClient > connects, sends messages, and reconnects on unexpected close
[WS] Connected
[WS] Closed { code: [33m1006[39m, reason: [32m'boom'[39m, wasClean: [33mfalse[39m }
[WS] Reconnecting in 10ms (attempt 1/1)

stdout | apps/web/src/lib/websocket.test.ts > WebSocketClient > initializeWebSocket creates singleton client and exposes telemetry
[WS] Connected

 âœ“ apps/web/src/lib/websocket.test.ts (3 tests) 18ms
 âœ“ apps/web/src/hooks/useKeyboardShortcuts.test.tsx (1 test) 10ms
 âœ“ apps/web/src/lib/errorLog.test.ts (3 tests) 9ms
 âœ“ apps/web/src/lib/theme.test.ts (6 tests) 5ms
 âœ“ apps/web/src/lib/api.streamAbort.test.ts (1 test) 3ms
 âœ“ apps/web/src/hello.test.ts (1 test) 1ms

â¯â¯â¯â¯â¯â¯â¯ Failed Tests 2 â¯â¯â¯â¯â¯â¯â¯

 FAIL  apps/web/src/App.test.tsx > App > toggles command palette on Cmd/Ctrl+K and supports onClose
 FAIL  apps/web/src/App.test.tsx > App > prevents default on Cmd/Ctrl+K
TypeError: Cannot read properties of undefined (reading 'addEventListener')
 â¯ apps/web/src/contexts/ThemeContext.tsx:60:16
     58|     };
     59| 
     60|     mediaQuery.addEventListener("change", handler);
       |                ^
     61|     return () => mediaQuery.removeEventListener("change", handler);
     62|   }, [theme]);
 â¯ Object.react_stack_bottom_frame node_modules/.pnpm/react-dom@19.2.3_react@19.2.3/node_modules/react-dom/cjs/react-dom-client.development.js:25989:20
 â¯ runWithFiberInDEV node_modules/.pnpm/react-dom@19.2.3_react@19.2.3/node_modules/react-dom/cjs/react-dom-client.development.js:874:13
 â¯ commitHookEffectListMount node_modules/.pnpm/react-dom@19.2.3_react@19.2.3/node_modules/react-dom/cjs/react-dom-client.development.js:13249:29
 â¯ commitHookPassiveMountEffects node_modules/.pnpm/react-dom@19.2.3_react@19.2.3/node_modules/react-dom/cjs/react-dom-client.development.js:13336:11
 â¯ commitPassiveMountOnFiber node_modules/.pnpm/react-dom@19.2.3_react@19.2.3/node_modules/react-dom/cjs/react-dom-client.development.js:15484:13
 â¯ recursivelyTraversePassiveMountEffects node_modules/.pnpm/react-dom@19.2.3_react@19.2.3/node_modules/react-dom/cjs/react-dom-client.development.js:15439:11
 â¯ commitPassiveMountOnFiber node_modules/.pnpm/react-dom@19.2.3_react@19.2.3/node_modules/react-dom/cjs/react-dom-client.development.js:15476:11
 â¯ recursivelyTraversePassiveMountEffects node_modules/.pnpm/react-dom@19.2.3_react@19.2.3/node_modules/react-dom/cjs/react-dom-client.development.js:15439:11
 â¯ commitPassiveMountOnFiber node_modules/.pnpm/react-dom@19.2.3_react@19.2.3/node_modules/react-dom/cjs/react-dom-client.development.js:15519:11

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[1/2]â¯


 Test Files  1 failed | 28 passed (29)
      Tests  2 failed | 171 passed | 1 skipped (174)
   Start at  12:11:29
   Duration  15.26s (transform 1.21s, setup 439ms, collect 2.78s, tests 8.71s, environment 771ms, prepare 137ms)

â€‰ELIFECYCLEâ€‰ Command failed with exit code 1.
